<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Nomad - KP45 Blogs</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Nomad";
        var mkdocs_page_input_path = "hashicorp/nomad.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> KP45 Blogs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Welcome to KP45 Blog</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../common-cli/">Common cli</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Hashicorp</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../consul/">Consul</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Nomad</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../vault/">Vault</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Local serials</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../local-serials/local-serials/">Local Serial Hardware Products</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">KP45 Blogs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Hashicorp</li>
      <li class="breadcrumb-item active">Nomad</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="quick-start">Quick Start</h2>
<p>Quick start guide for <a href="https://developer.hashicorp.com/nomad/tutorials/get-started?in=nomad/get-started">Nomad</a>.</p>
<p>This doc base on these precondition:</p>
<ul>
<li>Local Stack runs on a Linux host.</li>
<li>Nomad config as system service on the host.</li>
<li>Nomad server and client run on the host.</li>
</ul>
<h2 id="config">Config</h2>
<h3 id="server-config">Server Config</h3>
<p><code>vim /etc/nomad.d/nomad.hcl</code></p>
<pre><code class="language-hcl"># Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0

# Full configuration options can be found at https://www.nomadproject.io/docs/configuration

data_dir  = &quot;/opt/nomad&quot;
bind_addr = &quot;0.0.0.0
</code></pre>
<p><code>vim /etc/nomad.d/server.hcl</code></p>
<pre><code class="language-hcl">server {
  enabled          = true
  bootstrap_expect = 1
}
</code></pre>
<h3 id="client-config">Client Config</h3>
<p><code>vim /etc/nomad.d/client.hcl</code></p>
<pre><code class="language-hcl">client {
  enabled = true
  servers = [&quot;127.0.0.1&quot;]
  options {
    &quot;docker.cleanup.image&quot; = &quot;false&quot;
  }
  host_volume &quot;local-stack&quot; {
    path      = &quot;/data/local-stack&quot;
    read_only = false
  }
}

plugin &quot;raw_exec&quot; {
  config {
    enabled = true
  }
}

plugin &quot;docker&quot; {
  config {
    allow_privileged = true
    volumes {
      enabled      = true
    }
  }
  node_pool = &quot;default&quot;
}
</code></pre>
<p><code>mkdir /data/local-stack</code> for <code>host_volume</code> block, jobs can use this volume to mount folder in task.</p>
<h3 id="global-job-variables">Global Job Variables</h3>
<ul>
<li>Create a variable specification file named "spec.nv.hcl"</li>
</ul>
<pre><code class="language-bash">nomad var init
</code></pre>
<ul>
<li>Add variables to the file for all jobs</li>
</ul>
<pre><code class="language-hcl"># A variable path can be specified in the specification file
# and will be used when writing the variable without specifying a
# path in the command or when writing JSON directly to the `/var/`
# HTTP API endpoint
path = &quot;nomad/jobs&quot;

# The Namespace to write the variable can be included in the specification. This
# value can be overridden by specifying the &quot;-namespace&quot; flag on the &quot;put&quot;
# command.
# namespace = &quot;default&quot;

# The items map is the only strictly required part of a variable
# specification, since path and namespace can be set via other means.
# It contains the sensitive material to encrypt and store as a Nomad
# variable. The entire items map is encrypted and decrypted as a
# single unit.

# REMINDER: While keys in the items map can contain dots, using them
# in templates is easier when they do not. As a best practice, avoid
# dotted keys when possible.
items {
  MINIO_ENDPOINT     = &quot;&quot;
  MINIO_ACCESS_KEY   = &quot;&quot;
  MINIO_SECRECT_KEY  = &quot;&quot;
}

</code></pre>
<p>add your variables for all jobs into the <code>items</code> block, K/V format, like <code>MINIO_ACCESS_KEY</code> and <code>MINIO_SECRECT_KEY</code> above.</p>
<ul>
<li>Run command to put variables into Nomad.</li>
</ul>
<pre><code class="language-bash">nomad var put @spec.nv.hcl
</code></pre>
<h2 id="job-sample">Job Sample</h2>
<p>This sample is a job to sync OpenNeuro dataset to MinIO.</p>
<p>Key points:</p>
<ol>
<li>Docker driver</li>
<li>Use <code>template</code> block to write config file into docker container</li>
<li>Use <code>nomadVar</code> function to get global variables defined in <code>nomad/jobs</code> path</li>
<li>Use <code>mounts</code> block to add config file write by <code>template</code> block</li>
<li>Use <code>var</code> to set variable for job</li>
</ol>
<h3 id="steps">Steps:</h3>
<ul>
<li>Create job file</li>
</ul>
<p><code>vim openneuro.nomad.hcl</code></p>
<pre><code class="language-hcl">// run with var dataset
variable &quot;dataset&quot; {
  type = string
}

job &quot;openneuro-dataset-sync-to-minio&quot; {
  datacenters = [&quot;dc1&quot;]
  type        = &quot;batch&quot;
  group &quot;dataset-sync&quot; {
    task &quot;openneuro&quot; {
      driver = &quot;docker&quot;

      template {
        data        = &lt;&lt;EOF
                        {{- with nomadVar &quot;nomad/jobs&quot; -}}
                        [minio]
                        type = s3
                        provider = Minio
                        env_auth = false
                        access_key_id = {{ .MINIO_ACCESS_KEY }}
                        secret_access_key = {{ .MINIO_SECRECT_KEY }}
                        region =
                        endpoint = {{ .MINIO_ENDPOINT}}

                        [s3]
                        type = s3
                        provider = AWS
                        endpoint = https://s3.amazonaws.com
                        {{- end }}
                      EOF
        destination = &quot;local/rclone.conf&quot;
      }

      config {
        image = &quot;rclone/rclone:latest&quot;
        args  = [&quot;sync&quot;, &quot;s3:openneuro.org/${var.dataset}&quot;, &quot;minio:openneuro/${var.dataset}&quot;, &quot;--verbose&quot;]
        mounts = [
          {
            type = &quot;bind&quot;
            source = &quot;local&quot;
            target = &quot;/config/rclone/&quot;
          }
        ]
      }
    }
  }
}
</code></pre>
<ul>
<li>Run job</li>
</ul>
<pre><code class="language-bash">nomad job run -var=&quot;dataset=ds004776&quot; openneuro.nomad.hcl
</code></pre>
<h2 id="optional">Optional</h2>
<h3 id="nomad-pack">Nomad Pack</h3>
<ol>
<li>
<p>Install Nomad Pack : https://github.com/hashicorp/nomad-pack-community-registry</p>
</li>
<li>
<p>add default registry</p>
</li>
</ol>
<pre><code class="language-bash">nomad-pack registry add default https://github.com/hashicorp/nomad-pack-community-registry
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../consul/" class="btn btn-neutral float-left" title="Consul"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../overview/" class="btn btn-neutral float-right" title="Overview">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../consul/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../overview/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
